<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Happy birthday!!!</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
        }
        #fireworksCanvas {
            z-index: 1;
        }
        .canvas {
            z-index: 2;
        }
    </style>
</head>
<body>
    <canvas id="fireworksCanvas"></canvas>
    <canvas class="canvas"></canvas>

    <script>
    // 限制 Android DPR 為 1，iOS/其他裝置維持原生 DPR
    function getDPR() {
      return /Android/i.test(navigator.userAgent) ? 1 : (window.devicePixelRatio || 1);
    }

    // 根據 DPR 設定 canvas 解析度並返回 2D context
    function setupCanvas(canvas) {
      const dpr = getDPR();
      const w   = window.innerWidth;
      const h   = window.innerHeight;
      canvas.width  = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width  = w + 'px';
      canvas.style.height = h + 'px';
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      return ctx;
    }

    // 初始化兩個 canvas
    const fwCanvas  = document.getElementById("fireworksCanvas");
    const txtCanvas = document.querySelector(".canvas");
    const fwCtx     = setupCanvas(fwCanvas);
          setupCanvas(txtCanvas);

    window.addEventListener("resize", () => {
      setupCanvas(fwCanvas);
      setupCanvas(txtCanvas);
    }, false);

    // Firework 類別
    class Firework {
      constructor() {
        this.x = Math.random() * window.innerWidth;
        this.y = window.innerHeight;
        this.sx = Math.random() * 3 - 1.5;
        this.sy = Math.random() * -5 - 5;
        this.size = Math.random() * 2 + 1;
        const colorVal = Math.round(0xffffff * Math.random());
        [this.r, this.g, this.b] = [colorVal >> 16, (colorVal >> 8) & 255, colorVal & 255];
        this.shouldExplode = false;
      }
      update() {
        this.shouldExplode = this.sy >= -2 || this.y <= 100 ||
                             this.x <= 0 || this.x >= window.innerWidth;
        this.sy += 0.01;
        this.x += this.sx;
        this.y += this.sy;
      }
      draw() {
        fwCtx.fillStyle = `rgb(${this.r},${this.g},${this.b})`;
        fwCtx.beginPath();
        fwCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        fwCtx.fill();
      }
    }

    // Particle 類別
    class Particle {
      constructor(x, y, r, g, b) {
        this.x = x; this.y = y;
        this.sx = Math.random() * 3 - 1.5;
        this.sy = Math.random() * 3 - 1.5;
        this.size = Math.random() * 2 + 1;
        this.life = 100;
        this.r = r; this.g = g; this.b = b;
      }
      update() {
        this.x += this.sx;
        this.y += this.sy;
        this.life--;
      }
      draw() {
        fwCtx.fillStyle = `rgba(${this.r},${this.g},${this.b},${this.life/100})`;
        fwCtx.beginPath();
        fwCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        fwCtx.fill();
      }
    }

    const fireworks = [ new Firework() ];
    const particles = [];

    // S 系列 — 文字點陣動畫
    var S = {
      init: function() {
        S.Drawing.init('.canvas');
        document.body.classList.add('body--ready');
        const messages = ["祝", "祐寧姊姊", "生日快樂"];
        let idx = 0;
        (function next(){
          S.UI.simulate(messages[idx]);
          idx = (idx + 1) % messages.length;
          setTimeout(next, 3000);
        })();
      }
    };

    [S.Drawing, S.UI, S.Point, S.Color, S.Dot, S.ShapeBuilder, S.Shape] = [

      // Drawing
      (function(){
        var canvas, context, renderFn,
            rf = window.requestAnimationFrame ||
                 window.webkitRequestAnimationFrame ||
                 window.mozRequestAnimationFrame    ||
                 window.msRequestAnimationFrame     ||
                 function(cb){ window.setTimeout(cb, 1000/60); };

        return {
          init: function(el){
            canvas  = document.querySelector(el);
            context = setupCanvas(canvas);
            window.addEventListener('resize', ()=> context = setupCanvas(canvas));
          },
          clearFrame: function(){
            context.clearRect(0, 0, canvas.width, canvas.height);
          },
          getArea: function(){
            const dpr = getDPR();
            return { w: canvas.width / dpr, h: canvas.height / dpr };
          },
          drawCircle: function(p, c){
            context.fillStyle = c.render();
            context.beginPath();
            context.arc(p.x, p.y, p.z, 0, 2*Math.PI, true);
            context.fill();
          }
        };
      }()),

      // UI
      (function(){
        var seq = [];
        function iterate(){
          var cur = seq.shift();
          if(cur){
            if(cur === 'CLEAR_CANVAS'){
              S.Shape.clear();
            } else {
              S.Shape.switchShape(S.ShapeBuilder.letter(cur));
            }
            setTimeout(iterate, 1000);
          }
        }
        return {
          simulate: function(act){
            seq = seq.concat(act.split('|'));
            iterate();
          }
        };
      }()),

      // Point
      function(args){
        this.x = args.x; this.y = args.y;
        this.z = args.z; this.a = args.a; this.h = args.h;
      },

      // Color
      function(r, g, b, a){
        this.r = r; this.g = g; this.b = b; this.a = a;
      },

      // Dot
      function(x, y){
        this.p = new S.Point({ x:x, y:y, z:5, a:1, h:0 });
        this.e = 0.07; this.s = true;
        this.c = new S.Color(255,255,255,this.p.a);
        this.t = this.clone(); this.q = [];
      },

      // ShapeBuilder
      (function(){
        var gap=13,
            sc=document.createElement('canvas'),
            ctx2=sc.getContext('2d'),
            fs=500,
            ff='Avenir, Helvetica Neue, Helvetica, Arial, sans-serif';

        function fit(){
          sc.width = Math.floor(window.innerWidth/gap)*gap;
          sc.height= Math.floor(window.innerHeight/gap)*gap;
          ctx2.fillStyle='red';
          ctx2.textBaseline='middle';
          ctx2.textAlign='center';
        }

        function process(){
          var pixels=ctx2.getImageData(0,0,sc.width,sc.height).data,
              dots=[], x=0, y=0, fx=sc.width, fy=sc.height, w=0, h=0;
          for(var p=0; p<pixels.length; p+=4*gap){
            if(pixels[p+3]>0){
              dots.push(new S.Point({ x:x, y:y }));
              w = x>w?x:w; h = y>h?y:h;
              fx = x<fx?x:fx; fy=y<fy?y:fy;
            }
            x+=gap;
            if(x>=sc.width){
              x=0; y+=gap;
              p += gap*4*sc.width;
            }
          }
          return { dots:dots, w:w+fx, h:h+fy };
        }

        function setFont(s){
          ctx2.font = 'bold '+s+'px '+ff;
        }

        function init(){
          fit();
          window.addEventListener('resize', fit);
        }
        init();

        return {
          letter: function(l){
            setFont(fs);
            var s = Math.min(
              fs,
              (sc.width/ctx2.measureText(l).width)*0.8*fs,
              (sc.height/fs)*(isFinite(+l)?1:0.45)*fs
            );
            setFont(s);
            ctx2.clearRect(0,0,sc.width,sc.height);
            ctx2.fillText(l, sc.width/2, sc.height/2);
            return process();
          }
        };
      }()),

      // Shape
      (function(){
        var dots=[], width=0, height=0, cx=0, cy=0;
        function compensate(){
          var a=S.Drawing.getArea();
          cx = a.w/2 - width/2;
          cy = a.h/2 - height/2;
        }
        return {
          clear: function(){ dots=[]; },
          switchShape: function(n, fast){
            var a=S.Drawing.getArea(), size;
            width=n.w; height=n.h; compensate();
            if(n.dots.length>dots.length){
              size = n.dots.length - dots.length;
              for(var i=0;i<size;i++){
                dots.push(new S.Dot(a.w/2, a.h/2));
              }
            }
            var d=0, i=0;
            while(n.dots.length>0){
              i = Math.floor(Math.random()*n.dots.length);
              dots[d].e = fast?0.25:(dots[d].s?0.14:0.11);
              if(dots[d].s){
                dots[d].move(new S.Point({ z:Math.random()*20+10, a:Math.random(), h:18 }));
              } else {
                dots[d].move(new S.Point({ z:Math.random()*5+5, h: fast?18:30 }));
              }
              dots[d].s = true;
              dots[d].move(new S.Point({
                x: n.dots[i].x + cx,
                y: n.dots[i].y + cy,
                a: 1, z: 5, h: 0
              }));
              n.dots = n.dots.slice(0,i).concat(n.dots.slice(i+1));
              d++;
            }
            for(var j=d; j<dots.length; j++){
              if(dots[j].s){
                dots[j].move(new S.Point({ z:Math.random()*20+10, a:Math.random(), h:20 }));
                dots[j].s = false;
                dots[j].e = 0.04;
                dots[j].move(new S.Point({
                  x:Math.random()*a.w,
                  y:Math.random()*a.h,
                  a:0.3, z:Math.random()*4, h:0
                }));
              }
            }
          },
          render: function(){
            dots.forEach(function(dot){
              dot.render();
            });
          }
        };
      }())
    ];

    S.Color.prototype = {
      render: function(){
        return 'rgba('+this.r+','+this.g+','+this.b+','+this.a+')';
      }
    };

    S.Dot.prototype = {
      clone: function(){
        return new S.Point({
          x:this.p.x, y:this.p.y,
          z:this.p.z, a:this.p.a, h:this.p.h
        });
      },
      _draw: function(){
        this.c.a = this.p.a;
        S.Drawing.drawCircle(this.p, this.c);
      },
      _moveTowards: function(n){
        var det = this.distanceTo(n, true),
            dx = det[0], dy = det[1], d=det[2], e=this.e*d;
        if(this.p.h===-1){
          this.p.x=n.x; this.p.y=n.y; return true;
        }
        if(d>1){
          this.p.x -= (dx/d)*e;
          this.p.y -= (dy/d)*e;
        } else {
          if(this.p.h>0) this.p.h--;
          else return true;
        }
        return false;
      },
      _update: function(){
        if(this._moveTowards(this.t)){
          var p=this.q.shift();
          if(p){
            this.t.x=p.x||this.p.x;
            this.t.y=p.y||this.p.y;
            this.t.z=p.z||this.p.z;
            this.t.a=p.a||this.p.a;
            this.p.h=p.h||0;
          } else {
            if(this.s){
              this.p.x -= Math.sin(Math.random()*3.142);
              this.p.y -= Math.sin(Math.random()*3.142);
            } else {
              this.move(new S.Point({
                x:this.p.x+(Math.random()*50)-25,
                y:this.p.y+(Math.random()*50)-25
              }));
            }
          }
        }
        var d = this.p.a - this.t.a;
        this.p.a = Math.max(0.1, this.p.a - d*0.05);
        d = this.p.z - this.t.z;
        this.p.z = Math.max(1, this.p.z - d*0.05);
      },
      distanceTo: function(n, details){
        var dx=this.p.x-n.x, dy=this.p.y-n.y, d=Math.sqrt(dx*dx+dy*dy);
        return details?[dx,dy,d]:d;
      },
      move: function(p, avoid){
        if(!avoid || (avoid && this.distanceTo(p)>1)){
          this.q.push(p);
        }
      },
      render: function(){
        this._update();
        this._draw();
      }
    };

    // 統一動畫迴圈
    function loop() {
      // 煙花
      fwCtx.fillStyle = "rgba(0,0,0,0.2)";
      fwCtx.fillRect(0, 0, window.innerWidth, window.innerHeight);
      if (Math.random() < 0.05) fireworks.push(new Firework());
      fireworks.forEach((f,i) => {
        f.update(); f.draw();
        if (f.shouldExplode) {
          for (let j = 0; j < 50; j++) {
            particles.push(new Particle(f.x, f.y, f.r, f.g, f.b));
          }
          fireworks.splice(i, 1);
        }
      });
      particles.forEach((p,i) => {
        p.update(); p.draw();
        if (p.life <= 0) particles.splice(i, 1);
      });

      // 文字
      S.Drawing.clearFrame();
      S.Shape.render();

      requestAnimationFrame(loop);
    }

    window.addEventListener('load', () => {
      S.init();
      loop();
    });
    </script>
</body>
</html>
